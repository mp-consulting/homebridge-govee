<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Govee Plugin Settings</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
  <style>
    .card { margin-bottom: 1rem; }
    .device-list { max-height: 400px; overflow-y: auto; }
    .spinner-border { width: 1rem; height: 1rem; }
    .form-check { margin-bottom: 0.5rem; }
    .nav-tabs { margin-bottom: 1rem; }
    .info-icon {
      cursor: help;
      color: #6c757d;
      margin-left: 0.25rem;
    }
    .info-icon:hover { color: #0d6efd; }
    .device-card { border-left: 4px solid #0d6efd; }
    .device-card.ignored { border-left-color: #dc3545; opacity: 0.7; }
    .device-type-badge { font-size: 0.75rem; }
    .accordion-button:not(.collapsed) { background-color: #e7f1ff; }
    .btn-add-device { margin-bottom: 1rem; }
  </style>
</head>
<body>
  <div class="container py-4">
    <h3 class="mb-4">Govee Plugin</h3>

    <ul class="nav nav-tabs" id="mainTabs" role="tablist">
      <li class="nav-item" role="presentation">
        <button class="nav-link active" id="devices-tab" data-bs-toggle="tab" data-bs-target="#devices" type="button" role="tab">Devices</button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="settings-tab" data-bs-toggle="tab" data-bs-target="#settings" type="button" role="tab">Settings</button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="connection-tab" data-bs-toggle="tab" data-bs-target="#connection" type="button" role="tab">Connection</button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="tools-tab" data-bs-toggle="tab" data-bs-target="#tools" type="button" role="tab">Tools</button>
      </li>
    </ul>

    <div class="tab-content">
      <!-- Settings Tab -->
      <div class="tab-pane fade" id="settings" role="tabpanel">
        <div class="card">
          <div class="card-header">
            <h5 class="mb-0">Account Settings</h5>
          </div>
          <div class="card-body">
            <div class="mb-3">
              <label for="username" class="form-label">
                Govee Account Email
                <span class="info-icon" data-bs-toggle="tooltip" data-bs-placement="top" title="The email address you use to log in to the Govee app. Required for cloud control and device discovery.">&#9432;</span>
              </label>
              <input type="email" class="form-control" id="username" placeholder="your-email@example.com">
            </div>
            <div class="mb-3">
              <label for="password" class="form-label">
                Govee Account Password
                <span class="info-icon" data-bs-toggle="tooltip" data-bs-placement="top" title="Your Govee account password. This is stored locally and used only to authenticate with Govee servers.">&#9432;</span>
              </label>
              <div class="input-group">
                <input type="password" class="form-control" id="password">
                <button class="btn btn-outline-secondary" type="button" id="togglePassword">Show</button>
              </div>
            </div>
          </div>
        </div>

        <div class="card">
          <div class="card-header">
            <h5 class="mb-0">General Settings</h5>
          </div>
          <div class="card-body">
            <div class="form-check form-switch">
              <input class="form-check-input" type="checkbox" id="ignoreMatter">
              <label class="form-check-label" for="ignoreMatter">
                Ignore Matter Devices
                <span class="info-icon" data-bs-toggle="tooltip" data-bs-placement="top" title="Skip devices that support Matter protocol. Enable this if you're using Matter to connect those devices directly to HomeKit.">&#9432;</span>
              </label>
            </div>
            <div class="form-check form-switch">
              <input class="form-check-input" type="checkbox" id="disableDeviceLogging">
              <label class="form-check-label" for="disableDeviceLogging">
                Disable Device Logging
                <span class="info-icon" data-bs-toggle="tooltip" data-bs-placement="top" title="Stop logging device state changes to reduce log clutter. Errors will still be logged.">&#9432;</span>
              </label>
            </div>
            <div class="form-check form-switch">
              <input class="form-check-input" type="checkbox" id="colourSafeMode">
              <label class="form-check-label" for="colourSafeMode">
                Colour Safe Mode
                <span class="info-icon" data-bs-toggle="tooltip" data-bs-placement="top" title="Use a slower but more reliable method for setting colours. Enable this if you experience colour issues with your lights.">&#9432;</span>
              </label>
            </div>
          </div>
        </div>
      </div>

      <!-- Connection Tab -->
      <div class="tab-pane fade" id="connection" role="tabpanel">
        <div class="card">
          <div class="card-header">
            <h5 class="mb-0">AWS IoT Connection</h5>
          </div>
          <div class="card-body">
            <div class="form-check form-switch mb-3">
              <input class="form-check-input" type="checkbox" id="awsDisable">
              <label class="form-check-label" for="awsDisable">
                Disable AWS IoT Connection
                <span class="info-icon" data-bs-toggle="tooltip" data-bs-placement="top" title="Disable real-time cloud control via AWS IoT. The plugin will fall back to HTTP polling only. Not recommended unless you have connection issues.">&#9432;</span>
              </label>
            </div>
            <div class="mb-3">
              <label for="httpRefreshTime" class="form-label">
                HTTP Refresh Time (seconds)
                <span class="info-icon" data-bs-toggle="tooltip" data-bs-placement="top" title="How often to poll the Govee API for device state updates. Lower values mean faster updates but more API calls. Minimum 60 seconds.">&#9432;</span>
              </label>
              <input type="number" class="form-control" id="httpRefreshTime" min="60" value="60">
            </div>
          </div>
        </div>

        <div class="card">
          <div class="card-header">
            <h5 class="mb-0">LAN Connection</h5>
          </div>
          <div class="card-body">
            <div class="form-check form-switch mb-3">
              <input class="form-check-input" type="checkbox" id="lanDisable">
              <label class="form-check-label" for="lanDisable">
                Disable LAN Control
                <span class="info-icon" data-bs-toggle="tooltip" data-bs-placement="top" title="Disable local network control. LAN control is faster and works without internet. Only disable if you experience network issues.">&#9432;</span>
              </label>
            </div>
            <div class="mb-3">
              <label for="lanRefreshTime" class="form-label">
                LAN Refresh Time (seconds)
                <span class="info-icon" data-bs-toggle="tooltip" data-bs-placement="top" title="How often to poll LAN devices for state updates. Lower values mean faster updates. Minimum 15 seconds.">&#9432;</span>
              </label>
              <input type="number" class="form-control" id="lanRefreshTime" min="15" value="30">
            </div>
            <div class="mb-3">
              <label for="lanScanInterval" class="form-label">
                LAN Scan Interval (seconds)
                <span class="info-icon" data-bs-toggle="tooltip" data-bs-placement="top" title="How often to scan the network for new LAN-capable devices. Minimum 30 seconds.">&#9432;</span>
              </label>
              <input type="number" class="form-control" id="lanScanInterval" min="30" value="60">
            </div>
          </div>
        </div>

        <div class="card">
          <div class="card-header">
            <h5 class="mb-0">Bluetooth (BLE) Connection</h5>
          </div>
          <div class="card-body">
            <div class="form-check form-switch mb-3">
              <input class="form-check-input" type="checkbox" id="bleDisable">
              <label class="form-check-label" for="bleDisable">
                Disable Bluetooth Control
                <span class="info-icon" data-bs-toggle="tooltip" data-bs-placement="top" title="Disable Bluetooth Low Energy control. BLE works for nearby devices without network. Requires compatible hardware (works best on Raspberry Pi).">&#9432;</span>
              </label>
            </div>
            <div class="mb-3">
              <label for="bleRefreshTime" class="form-label">
                BLE Refresh Time (seconds)
                <span class="info-icon" data-bs-toggle="tooltip" data-bs-placement="top" title="How often to scan for BLE sensor readings (temperature, humidity, etc.). Minimum 15 seconds.">&#9432;</span>
              </label>
              <input type="number" class="form-control" id="bleRefreshTime" min="15" value="30">
            </div>
            <div class="mb-3">
              <label for="bleControlInterval" class="form-label">
                BLE Control Interval (ms)
                <span class="info-icon" data-bs-toggle="tooltip" data-bs-placement="top" title="Minimum time between BLE commands to prevent overwhelming devices. Increase if you experience connection drops. Minimum 500ms.">&#9432;</span>
              </label>
              <input type="number" class="form-control" id="bleControlInterval" min="500" value="500">
            </div>
          </div>
        </div>
      </div>

      <!-- Devices Tab -->
      <div class="tab-pane fade show active" id="devices" role="tabpanel">
        <div class="alert alert-info">
          <strong>Tip:</strong> Configure device-specific settings here. Use "Discover Devices" in the Tools tab to find your device IDs.
        </div>

        <div class="accordion" id="deviceAccordion">
          <!-- Light Devices -->
          <div class="accordion-item">
            <h2 class="accordion-header">
              <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#lightDevicesCollapse">
                <span class="me-2">üí°</span> Light Devices <span class="badge bg-secondary ms-2" id="lightDevicesCount">0</span>
              </button>
            </h2>
            <div id="lightDevicesCollapse" class="accordion-collapse collapse" data-bs-parent="#deviceAccordion">
              <div class="accordion-body">
                <button class="btn btn-outline-primary btn-sm btn-add-device" onclick="addDevice('lightDevices')">+ Add Light Device</button>
                <div id="lightDevicesList"></div>
              </div>
            </div>
          </div>

          <!-- Switch Devices -->
          <div class="accordion-item">
            <h2 class="accordion-header">
              <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#switchDevicesCollapse">
                <span class="me-2">üîå</span> Switch/Outlet Devices <span class="badge bg-secondary ms-2" id="switchDevicesCount">0</span>
              </button>
            </h2>
            <div id="switchDevicesCollapse" class="accordion-collapse collapse" data-bs-parent="#deviceAccordion">
              <div class="accordion-body">
                <button class="btn btn-outline-primary btn-sm btn-add-device" onclick="addDevice('switchDevices')">+ Add Switch Device</button>
                <div id="switchDevicesList"></div>
              </div>
            </div>
          </div>

          <!-- Thermo Devices -->
          <div class="accordion-item">
            <h2 class="accordion-header">
              <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#thermoDevicesCollapse">
                <span class="me-2">üå°Ô∏è</span> Temperature/Humidity Sensors <span class="badge bg-secondary ms-2" id="thermoDevicesCount">0</span>
              </button>
            </h2>
            <div id="thermoDevicesCollapse" class="accordion-collapse collapse" data-bs-parent="#deviceAccordion">
              <div class="accordion-body">
                <button class="btn btn-outline-primary btn-sm btn-add-device" onclick="addDevice('thermoDevices')">+ Add Sensor</button>
                <div id="thermoDevicesList"></div>
              </div>
            </div>
          </div>

          <!-- Leak Devices -->
          <div class="accordion-item">
            <h2 class="accordion-header">
              <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#leakDevicesCollapse">
                <span class="me-2">üíß</span> Leak Sensors <span class="badge bg-secondary ms-2" id="leakDevicesCount">0</span>
              </button>
            </h2>
            <div id="leakDevicesCollapse" class="accordion-collapse collapse" data-bs-parent="#deviceAccordion">
              <div class="accordion-body">
                <button class="btn btn-outline-primary btn-sm btn-add-device" onclick="addDevice('leakDevices')">+ Add Leak Sensor</button>
                <div id="leakDevicesList"></div>
              </div>
            </div>
          </div>

          <!-- Fan Devices -->
          <div class="accordion-item">
            <h2 class="accordion-header">
              <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#fanDevicesCollapse">
                <span class="me-2">üåÄ</span> Fan Devices <span class="badge bg-secondary ms-2" id="fanDevicesCount">0</span>
              </button>
            </h2>
            <div id="fanDevicesCollapse" class="accordion-collapse collapse" data-bs-parent="#deviceAccordion">
              <div class="accordion-body">
                <button class="btn btn-outline-primary btn-sm btn-add-device" onclick="addDevice('fanDevices')">+ Add Fan</button>
                <div id="fanDevicesList"></div>
              </div>
            </div>
          </div>

          <!-- Heater Devices -->
          <div class="accordion-item">
            <h2 class="accordion-header">
              <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#heaterDevicesCollapse">
                <span class="me-2">üî•</span> Heater Devices <span class="badge bg-secondary ms-2" id="heaterDevicesCount">0</span>
              </button>
            </h2>
            <div id="heaterDevicesCollapse" class="accordion-collapse collapse" data-bs-parent="#deviceAccordion">
              <div class="accordion-body">
                <button class="btn btn-outline-primary btn-sm btn-add-device" onclick="addDevice('heaterDevices')">+ Add Heater</button>
                <div id="heaterDevicesList"></div>
              </div>
            </div>
          </div>

          <!-- Humidifier Devices -->
          <div class="accordion-item">
            <h2 class="accordion-header">
              <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#humidifierDevicesCollapse">
                <span class="me-2">üí®</span> Humidifier Devices <span class="badge bg-secondary ms-2" id="humidifierDevicesCount">0</span>
              </button>
            </h2>
            <div id="humidifierDevicesCollapse" class="accordion-collapse collapse" data-bs-parent="#deviceAccordion">
              <div class="accordion-body">
                <button class="btn btn-outline-primary btn-sm btn-add-device" onclick="addDevice('humidifierDevices')">+ Add Humidifier</button>
                <div id="humidifierDevicesList"></div>
              </div>
            </div>
          </div>

          <!-- Purifier Devices -->
          <div class="accordion-item">
            <h2 class="accordion-header">
              <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#purifierDevicesCollapse">
                <span class="me-2">üå¨Ô∏è</span> Air Purifier Devices <span class="badge bg-secondary ms-2" id="purifierDevicesCount">0</span>
              </button>
            </h2>
            <div id="purifierDevicesCollapse" class="accordion-collapse collapse" data-bs-parent="#deviceAccordion">
              <div class="accordion-body">
                <button class="btn btn-outline-primary btn-sm btn-add-device" onclick="addDevice('purifierDevices')">+ Add Purifier</button>
                <div id="purifierDevicesList"></div>
              </div>
            </div>
          </div>

          <!-- Dehumidifier Devices -->
          <div class="accordion-item">
            <h2 class="accordion-header">
              <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#dehumidifierDevicesCollapse">
                <span class="me-2">üí¶</span> Dehumidifier Devices <span class="badge bg-secondary ms-2" id="dehumidifierDevicesCount">0</span>
              </button>
            </h2>
            <div id="dehumidifierDevicesCollapse" class="accordion-collapse collapse" data-bs-parent="#deviceAccordion">
              <div class="accordion-body">
                <button class="btn btn-outline-primary btn-sm btn-add-device" onclick="addDevice('dehumidifierDevices')">+ Add Dehumidifier</button>
                <div id="dehumidifierDevicesList"></div>
              </div>
            </div>
          </div>

          <!-- Diffuser Devices -->
          <div class="accordion-item">
            <h2 class="accordion-header">
              <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#diffuserDevicesCollapse">
                <span class="me-2">üå∏</span> Diffuser Devices <span class="badge bg-secondary ms-2" id="diffuserDevicesCount">0</span>
              </button>
            </h2>
            <div id="diffuserDevicesCollapse" class="accordion-collapse collapse" data-bs-parent="#deviceAccordion">
              <div class="accordion-body">
                <button class="btn btn-outline-primary btn-sm btn-add-device" onclick="addDevice('diffuserDevices')">+ Add Diffuser</button>
                <div id="diffuserDevicesList"></div>
              </div>
            </div>
          </div>

          <!-- Kettle Devices -->
          <div class="accordion-item">
            <h2 class="accordion-header">
              <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#kettleDevicesCollapse">
                <span class="me-2">‚òï</span> Kettle Devices <span class="badge bg-secondary ms-2" id="kettleDevicesCount">0</span>
              </button>
            </h2>
            <div id="kettleDevicesCollapse" class="accordion-collapse collapse" data-bs-parent="#deviceAccordion">
              <div class="accordion-body">
                <button class="btn btn-outline-primary btn-sm btn-add-device" onclick="addDevice('kettleDevices')">+ Add Kettle</button>
                <div id="kettleDevicesList"></div>
              </div>
            </div>
          </div>

          <!-- Ice Maker Devices -->
          <div class="accordion-item">
            <h2 class="accordion-header">
              <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#iceMakerDevicesCollapse">
                <span class="me-2">üßä</span> Ice Maker Devices <span class="badge bg-secondary ms-2" id="iceMakerDevicesCount">0</span>
              </button>
            </h2>
            <div id="iceMakerDevicesCollapse" class="accordion-collapse collapse" data-bs-parent="#deviceAccordion">
              <div class="accordion-body">
                <button class="btn btn-outline-primary btn-sm btn-add-device" onclick="addDevice('iceMakerDevices')">+ Add Ice Maker</button>
                <div id="iceMakerDevicesList"></div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Tools Tab -->
      <div class="tab-pane fade" id="tools" role="tabpanel">
        <div class="card">
          <div class="card-header">
            <h5 class="mb-0">Account Connection Test</h5>
          </div>
          <div class="card-body">
            <p class="text-muted">Test your Govee account credentials to verify they work correctly.</p>
            <button id="testLoginBtn" class="btn btn-primary">
              <span id="testLoginSpinner" class="spinner-border d-none" role="status"></span>
              Test Connection
            </button>
            <div id="loginResult" class="mt-3"></div>
          </div>
        </div>

        <div class="card">
          <div class="card-header">
            <h5 class="mb-0">Device Discovery</h5>
          </div>
          <div class="card-body">
            <p class="text-muted">Discover all devices linked to your Govee account. Use the device IDs to configure specific devices in the Devices tab.</p>
            <button id="discoverBtn" class="btn btn-secondary">
              <span id="discoverSpinner" class="spinner-border d-none" role="status"></span>
              Discover Devices
            </button>
            <div id="deviceList" class="device-list mt-3"></div>
          </div>
        </div>

        <div class="card">
          <div class="card-header">
            <h5 class="mb-0">Documentation</h5>
          </div>
          <div class="card-body">
            <p>For more information about configuration options, see the <a href="https://github.com/mp-consulting/homebridge-govee#readme" target="_blank">README</a>.</p>
            <ul>
              <li><strong>AWS IoT:</strong> Real-time control via Govee cloud (requires credentials)</li>
              <li><strong>LAN:</strong> Local network control (faster, works without internet)</li>
              <li><strong>BLE:</strong> Bluetooth control for nearby devices (requires compatible hardware)</li>
            </ul>
          </div>
        </div>
      </div>
    </div>

    <!-- Save Button -->
    <div class="d-grid gap-2 mt-3">
      <button id="saveBtn" class="btn btn-success btn-lg">
        <span id="saveSpinner" class="spinner-border d-none" role="status"></span>
        Save Configuration
      </button>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    // Model to device type mapping (from constants.ts)
    const modelCategories = {
      rgb: [
        'H6001', 'H6002', 'H6003', 'H6004', 'H6005', 'H6006', 'H6007', 'H6008', 'H6009',
        'H600A', 'H600B', 'H600C', 'H600D', 'H6010', 'H6011', 'H6013', 'H601A', 'H601B',
        'H601C', 'H601D', 'H601E', 'H6020', 'H6022', 'H6038', 'H6039', 'H6042', 'H6043',
        'H6046', 'H6047', 'H6048', 'H6049', 'H604A', 'H604B', 'H604C', 'H604D', 'H6050',
        'H6051', 'H6052', 'H6053', 'H6054', 'H6055', 'H6056', 'H6057', 'H6058', 'H6059',
        'H605A', 'H605B', 'H605C', 'H605D', 'H6061', 'H6062', 'H6063', 'H6065', 'H6066',
        'H6067', 'H6069', 'H606A', 'H6071', 'H6072', 'H6073', 'H6075', 'H6076', 'H6078',
        'H6079', 'H607C', 'H6083', 'H6085', 'H6086', 'H6087', 'H6088', 'H6089', 'H608A',
        'H608B', 'H608C', 'H608D', 'H6091', 'H6092', 'H6093', 'H6095', 'H6097', 'H6098',
        'H6099', 'H60A0', 'H60A1', 'H60A4', 'H60A6', 'H60B0', 'H60B1', 'H60B2', 'H60C1',
        'H6101', 'H6102', 'H6104', 'H6107', 'H6109', 'H610A', 'H610B', 'H6110', 'H6114',
        'H6116', 'H6117', 'H611A', 'H611B', 'H611C', 'H611Z', 'H6121', 'H6125', 'H6126',
        'H6127', 'H6129', 'H612A', 'H612B', 'H612C', 'H612D', 'H612E', 'H612F', 'H6135',
        'H6137', 'H6138', 'H6139', 'H613A', 'H613B', 'H613C', 'H613D', 'H613E', 'H613F',
        'H613G', 'H6141', 'H6142', 'H6143', 'H6144', 'H6145', 'H6146', 'H6147', 'H6148',
        'H614A', 'H614B', 'H614C', 'H614D', 'H614E', 'H6154', 'H6159', 'H615A', 'H615B',
        'H615C', 'H615D', 'H615E', 'H615F', 'H6160', 'H6161', 'H6163', 'H6167', 'H6168',
        'H6169', 'H616C', 'H616D', 'H616E', 'H6170', 'H6171', 'H6172', 'H6173', 'H6175',
        'H6176', 'H6178', 'H6179', 'H617A', 'H617C', 'H617E', 'H617F', 'H6181', 'H6182',
        'H6185', 'H6188', 'H618A', 'H618C', 'H618E', 'H618F', 'H6195', 'H6196', 'H6198',
        'H6199', 'H619A', 'H619B', 'H619C', 'H619D', 'H619E', 'H619Z', 'H61A0', 'H61A1',
        'H61A2', 'H61A3', 'H61A5', 'H61A8', 'H61A9', 'H61B1', 'H61B2', 'H61B3', 'H61B5',
        'H61B6', 'H61B8', 'H61B9', 'H61BA', 'H61BC', 'H61BE', 'H61C2', 'H61C3', 'H61C5',
        'H61D3', 'H61D5', 'H61D6', 'H61E0', 'H61E1', 'H61E5', 'H61E6', 'H61F2', 'H61F5',
        'H61F6', 'H6601', 'H6602', 'H6604', 'H6609', 'H6630', 'H6631', 'H6640', 'H6641',
        'H6671', 'H6672', 'H66A0', 'H66A1', 'H6800', 'H6810', 'H6811', 'H6840', 'H6841',
        'H6871', 'H7001', 'H7002', 'H7005', 'H7006', 'H7007', 'H7008', 'H7010', 'H7011',
        'H7012', 'H7013', 'H7015', 'H7016', 'H7017', 'H7019', 'H7020', 'H7021', 'H7022',
        'H7023', 'H7024', 'H7025', 'H7026', 'H7028', 'H7029', 'H702A', 'H702B', 'H702C',
        'H7031', 'H7032', 'H7033', 'H7037', 'H7038', 'H7039', 'H703A', 'H703B', 'H7041',
        'H7042', 'H7050', 'H7051', 'H7052', 'H7053', 'H7055', 'H7056', 'H7057', 'H7058',
        'H705A', 'H705B', 'H705C', 'H705D', 'H705E', 'H705F', 'H7060', 'H7061', 'H7062',
        'H7063', 'H7065', 'H7066', 'H7067', 'H7068', 'H7069', 'H706A', 'H706B', 'H706C',
        'H7070', 'H7073', 'H7075', 'H7076', 'H7078', 'H707A', 'H7086', 'H7087', 'H7090',
        'H7092', 'H7093', 'H7094', 'H7095', 'H70A1', 'H70A2', 'H70A3', 'H70B1', 'H70B3',
        'H70B4', 'H70B5', 'H70B6', 'H70BC', 'H70C1', 'H70C2', 'H70C4', 'H70C5', 'H70C7',
        'H70C9', 'H70CB', 'H70D1', 'H70D2', 'H70D3', 'H801B', 'H801C', 'H8022', 'H805A',
        'H805B', 'H805C', 'H806A', 'H8072', 'H808A', 'H80A4', 'H80C4', 'H80C5', 'H8604',
        'H8840', 'H8841', 'HXXXX'
      ],
      switchSingle: ['H5001', 'H5080', 'H5081', 'H5083', 'H5086', 'H7014'],
      switchDouble: ['H5082'],
      switchTriple: ['H5160'],
      sensorLeak: ['H5054', 'H5058'],
      sensorThermo: [
        'B5178', 'H5051', 'H5052', 'H5053', 'H5055', 'H5071', 'H5072', 'H5074', 'H5075',
        'H5100', 'H5101', 'H5102', 'H5103', 'H5104', 'H5105', 'H5108', 'H5109', 'H5110',
        'H5112', 'H5174', 'H5177', 'H5179', 'H5183', 'H5190'
      ],
      sensorThermo4: ['H5198'],
      sensorMonitor: ['H5106'],
      fan: ['H7100', 'H7101', 'H7102', 'H7105', 'H7106', 'H7107', 'H7111'],
      heater1: ['H7130', 'H713A', 'H713B', 'H713C'],
      heater2: ['H7131', 'H7132', 'H7133', 'H7134', 'H7135'],
      dehumidifier: ['H7150', 'H7151'],
      humidifier: ['H7140', 'H7141', 'H7142', 'H7143', 'H7145', 'H7147', 'H7148', 'H7149', 'H714E', 'H7160'],
      purifier: ['H7120', 'H7121', 'H7122', 'H7123', 'H7124', 'H7126', 'H7127', 'H7128', 'H7129', 'H712C'],
      diffuser: ['H7161', 'H7162'],
      iceMaker: ['H7172', 'H717D'],
      kettle: ['H7170', 'H7171', 'H7173', 'H7175', 'H717A'],
      sensorButton: ['H5122'],
      sensorContact: ['H5123'],
      sensorPresence: ['H5127']
    };

    // Determine device type from model SKU
    function getDeviceTypeFromModel(model) {
      if (!model) return 'lightDevices'; // Default to light

      const sku = model.toUpperCase();

      // Check specific categories first (most specific to least)
      if (modelCategories.switchSingle.includes(sku) ||
          modelCategories.switchDouble.includes(sku) ||
          modelCategories.switchTriple.includes(sku)) {
        return 'switchDevices';
      }
      if (modelCategories.sensorLeak.includes(sku)) return 'leakDevices';
      if (modelCategories.sensorThermo.includes(sku) ||
          modelCategories.sensorThermo4.includes(sku) ||
          modelCategories.sensorMonitor.includes(sku)) {
        return 'thermoDevices';
      }
      if (modelCategories.sensorButton.includes(sku) ||
          modelCategories.sensorContact.includes(sku) ||
          modelCategories.sensorPresence.includes(sku)) {
        return 'thermoDevices'; // Group other sensors with thermo
      }
      if (modelCategories.fan.includes(sku)) return 'fanDevices';
      if (modelCategories.heater1.includes(sku) ||
          modelCategories.heater2.includes(sku)) {
        return 'heaterDevices';
      }
      if (modelCategories.humidifier.includes(sku)) return 'humidifierDevices';
      if (modelCategories.dehumidifier.includes(sku)) return 'dehumidifierDevices';
      if (modelCategories.purifier.includes(sku)) return 'purifierDevices';
      if (modelCategories.diffuser.includes(sku)) return 'diffuserDevices';
      if (modelCategories.iceMaker.includes(sku)) return 'iceMakerDevices';
      if (modelCategories.kettle.includes(sku)) return 'kettleDevices';
      if (modelCategories.rgb.includes(sku)) return 'lightDevices';

      // Default to light for unknown models
      return 'lightDevices';
    }

    // Device type configurations
    const deviceTypes = {
      lightDevices: {
        fields: [
          { id: 'deviceId', label: 'Device ID', type: 'text', required: true },
          { id: 'label', label: 'Custom Label', type: 'text' },
          { id: 'ignoreDevice', label: 'Ignore Device', type: 'checkbox' },
          { id: 'showAs', label: 'Show As', type: 'select', options: [
            { value: 'default', label: 'Light (default)' },
            { value: 'switch', label: 'Switch' }
          ]},
          { id: 'customIPAddress', label: 'Custom IP Address', type: 'text', advanced: true },
          { id: 'customAddress', label: 'Custom BLE Address', type: 'text', advanced: true },
          { id: 'brightnessStep', label: 'Brightness Step', type: 'number', min: 1, max: 100, advanced: true },
          { id: 'adaptiveLightingShift', label: 'Adaptive Lighting Shift', type: 'number', advanced: true },
          { id: 'awsBrightnessNoScale', label: 'AWS Brightness No Scale', type: 'checkbox', advanced: true },
          { id: 'awsColourMode', label: 'AWS Colour Mode', type: 'select', advanced: true, options: [
            { value: 'default', label: 'Default' },
            { value: 'rgb', label: 'RGB' },
            { value: 'redgreenblue', label: 'Red/Green/Blue' }
          ]}
        ]
      },
      switchDevices: {
        fields: [
          { id: 'deviceId', label: 'Device ID', type: 'text', required: true },
          { id: 'label', label: 'Custom Label', type: 'text' },
          { id: 'ignoreDevice', label: 'Ignore Device', type: 'checkbox' },
          { id: 'showAs', label: 'Show As', type: 'select', options: [
            { value: 'default', label: 'Outlet (default)' },
            { value: 'switch', label: 'Switch' },
            { value: 'purifier', label: 'Air Purifier' },
            { value: 'heater', label: 'Heater' },
            { value: 'cooler', label: 'Cooler' },
            { value: 'tap', label: 'Tap/Faucet' },
            { value: 'valve', label: 'Valve' },
            { value: 'audio', label: 'Audio Receiver' },
            { value: 'box', label: 'Set-Top Box' },
            { value: 'stick', label: 'Streaming Stick' }
          ]},
          { id: 'temperatureSource', label: 'Temperature Source (Device ID)', type: 'text', advanced: true }
        ]
      },
      thermoDevices: {
        fields: [
          { id: 'deviceId', label: 'Device ID', type: 'text', required: true },
          { id: 'label', label: 'Custom Label', type: 'text' },
          { id: 'ignoreDevice', label: 'Ignore Device', type: 'checkbox' },
          { id: 'lowBattThreshold', label: 'Low Battery Threshold (%)', type: 'number', min: 1, max: 100 },
          { id: 'showExtraSwitch', label: 'Show Extra Switch', type: 'checkbox' }
        ]
      },
      leakDevices: {
        fields: [
          { id: 'deviceId', label: 'Device ID', type: 'text', required: true },
          { id: 'label', label: 'Custom Label', type: 'text' },
          { id: 'ignoreDevice', label: 'Ignore Device', type: 'checkbox' },
          { id: 'lowBattThreshold', label: 'Low Battery Threshold (%)', type: 'number', min: 1, max: 100 }
        ]
      },
      fanDevices: {
        fields: [
          { id: 'deviceId', label: 'Device ID', type: 'text', required: true },
          { id: 'label', label: 'Custom Label', type: 'text' },
          { id: 'ignoreDevice', label: 'Ignore Device', type: 'checkbox' },
          { id: 'hideLight', label: 'Hide Light Control', type: 'checkbox' }
        ]
      },
      heaterDevices: {
        fields: [
          { id: 'deviceId', label: 'Device ID', type: 'text', required: true },
          { id: 'label', label: 'Custom Label', type: 'text' },
          { id: 'ignoreDevice', label: 'Ignore Device', type: 'checkbox' },
          { id: 'tempReporting', label: 'Temperature Reporting', type: 'checkbox' }
        ]
      },
      humidifierDevices: {
        fields: [
          { id: 'deviceId', label: 'Device ID', type: 'text', required: true },
          { id: 'label', label: 'Custom Label', type: 'text' },
          { id: 'ignoreDevice', label: 'Ignore Device', type: 'checkbox' }
        ]
      },
      purifierDevices: {
        fields: [
          { id: 'deviceId', label: 'Device ID', type: 'text', required: true },
          { id: 'label', label: 'Custom Label', type: 'text' },
          { id: 'ignoreDevice', label: 'Ignore Device', type: 'checkbox' }
        ]
      },
      dehumidifierDevices: {
        fields: [
          { id: 'deviceId', label: 'Device ID', type: 'text', required: true },
          { id: 'label', label: 'Custom Label', type: 'text' },
          { id: 'ignoreDevice', label: 'Ignore Device', type: 'checkbox' }
        ]
      },
      diffuserDevices: {
        fields: [
          { id: 'deviceId', label: 'Device ID', type: 'text', required: true },
          { id: 'label', label: 'Custom Label', type: 'text' },
          { id: 'ignoreDevice', label: 'Ignore Device', type: 'checkbox' }
        ]
      },
      kettleDevices: {
        fields: [
          { id: 'deviceId', label: 'Device ID', type: 'text', required: true },
          { id: 'label', label: 'Custom Label', type: 'text' },
          { id: 'ignoreDevice', label: 'Ignore Device', type: 'checkbox' },
          { id: 'hideModeGreenTea', label: 'Hide Green Tea Mode', type: 'checkbox', advanced: true },
          { id: 'hideModeOolongTea', label: 'Hide Oolong Tea Mode', type: 'checkbox', advanced: true },
          { id: 'hideModeCoffee', label: 'Hide Coffee Mode', type: 'checkbox', advanced: true },
          { id: 'hideModeBlackTea', label: 'Hide Black Tea Mode', type: 'checkbox', advanced: true },
          { id: 'showCustomMode1', label: 'Show Custom Mode 1', type: 'checkbox', advanced: true },
          { id: 'showCustomMode2', label: 'Show Custom Mode 2', type: 'checkbox', advanced: true }
        ]
      },
      iceMakerDevices: {
        fields: [
          { id: 'deviceId', label: 'Device ID', type: 'text', required: true },
          { id: 'label', label: 'Custom Label', type: 'text' },
          { id: 'ignoreDevice', label: 'Ignore Device', type: 'checkbox' }
        ]
      }
    };

    let pluginConfig = { platform: 'Govee', name: 'Govee' };

    function renderDeviceField(type, index, field, value) {
      const fieldId = `${type}_${index}_${field.id}`;
      let html = '';

      if (field.type === 'checkbox') {
        html = `
          <div class="form-check form-switch mb-2">
            <input class="form-check-input device-field" type="checkbox" id="${fieldId}"
              data-type="${type}" data-index="${index}" data-field="${field.id}"
              ${value ? 'checked' : ''}>
            <label class="form-check-label" for="${fieldId}">${field.label}</label>
          </div>`;
      } else if (field.type === 'select') {
        const options = field.options.map(opt =>
          `<option value="${opt.value}" ${value === opt.value ? 'selected' : ''}>${opt.label}</option>`
        ).join('');
        html = `
          <div class="mb-2">
            <label class="form-label" for="${fieldId}">${field.label}</label>
            <select class="form-select form-select-sm device-field" id="${fieldId}"
              data-type="${type}" data-index="${index}" data-field="${field.id}">
              ${options}
            </select>
          </div>`;
      } else {
        html = `
          <div class="mb-2">
            <label class="form-label" for="${fieldId}">${field.label}${field.required ? ' *' : ''}</label>
            <input type="${field.type}" class="form-control form-control-sm device-field" id="${fieldId}"
              data-type="${type}" data-index="${index}" data-field="${field.id}"
              value="${value || ''}" ${field.min !== undefined ? `min="${field.min}"` : ''}
              ${field.max !== undefined ? `max="${field.max}"` : ''}>
          </div>`;
      }
      return html;
    }

    function renderDevice(type, index, device) {
      const config = deviceTypes[type];
      const isIgnored = device.ignoreDevice;
      const displayName = device.label || device.deviceId || 'New Device';

      const basicFields = config.fields.filter(f => !f.advanced);
      const advancedFields = config.fields.filter(f => f.advanced);

      let fieldsHtml = basicFields.map(f => renderDeviceField(type, index, f, device[f.id])).join('');

      if (advancedFields.length > 0) {
        const advancedHtml = advancedFields.map(f => renderDeviceField(type, index, f, device[f.id])).join('');
        fieldsHtml += `
          <div class="mt-2">
            <a class="btn btn-link btn-sm p-0" data-bs-toggle="collapse" href="#${type}_${index}_advanced">
              Advanced Settings
            </a>
            <div class="collapse mt-2" id="${type}_${index}_advanced">
              ${advancedHtml}
            </div>
          </div>`;
      }

      return `
        <div class="card device-card mb-2 ${isIgnored ? 'ignored' : ''}" id="${type}_${index}_card">
          <div class="card-body py-2">
            <div class="d-flex justify-content-between align-items-center mb-2">
              <strong>${displayName}</strong>
              <button class="btn btn-outline-danger btn-sm" onclick="removeDevice('${type}', ${index})">Remove</button>
            </div>
            ${fieldsHtml}
          </div>
        </div>`;
    }

    function renderDeviceList(type) {
      const devices = pluginConfig[type] || [];
      const container = document.getElementById(`${type}List`);
      const countBadge = document.getElementById(`${type}Count`);

      if (devices.length === 0) {
        container.innerHTML = '<p class="text-muted">No devices configured.</p>';
      } else {
        container.innerHTML = devices.map((device, index) => renderDevice(type, index, device)).join('');
      }

      countBadge.textContent = devices.length;

      // Add event listeners for field changes
      container.querySelectorAll('.device-field').forEach(field => {
        field.addEventListener('change', handleDeviceFieldChange);
        field.addEventListener('input', handleDeviceFieldChange);
      });
    }

    function handleDeviceFieldChange(event) {
      const field = event.target;
      const type = field.dataset.type;
      const index = parseInt(field.dataset.index);
      const fieldName = field.dataset.field;

      if (!pluginConfig[type]) pluginConfig[type] = [];
      if (!pluginConfig[type][index]) pluginConfig[type][index] = {};

      if (field.type === 'checkbox') {
        pluginConfig[type][index][fieldName] = field.checked;
      } else if (field.type === 'number') {
        const val = parseInt(field.value);
        if (!isNaN(val)) {
          pluginConfig[type][index][fieldName] = val;
        }
      } else {
        const val = field.value.trim();
        if (val) {
          pluginConfig[type][index][fieldName] = val;
        } else {
          delete pluginConfig[type][index][fieldName];
        }
      }

      // Update card appearance if ignoreDevice changed
      if (fieldName === 'ignoreDevice') {
        const card = document.getElementById(`${type}_${index}_card`);
        if (card) {
          card.classList.toggle('ignored', field.checked);
        }
      }
    }

    function addDevice(type) {
      if (!pluginConfig[type]) pluginConfig[type] = [];
      pluginConfig[type].push({ deviceId: '' });
      renderDeviceList(type);
    }

    function removeDevice(type, index) {
      if (pluginConfig[type]) {
        pluginConfig[type].splice(index, 1);
        if (pluginConfig[type].length === 0) {
          delete pluginConfig[type];
        }
        renderDeviceList(type);
      }
    }

    (async () => {
      // Get the homebridge object
      const homebridge = window.homebridge;
      if (!homebridge) {
        console.error('Homebridge UI utils not available');
        return;
      }

      // Initialize Bootstrap tooltips
      const tooltipTriggerList = document.querySelectorAll('[data-bs-toggle="tooltip"]');
      tooltipTriggerList.forEach(el => new bootstrap.Tooltip(el));

      // Field mappings
      const textFields = ['username', 'password'];
      const numberFields = ['httpRefreshTime', 'lanRefreshTime', 'lanScanInterval', 'bleRefreshTime', 'bleControlInterval'];
      const booleanFields = ['ignoreMatter', 'disableDeviceLogging', 'colourSafeMode', 'awsDisable', 'lanDisable', 'bleDisable'];

      // Load configuration
      const loadConfig = async () => {
        try {
          const config = await homebridge.getPluginConfig();
          pluginConfig = config[0] || { platform: 'Govee', name: 'Govee' };

          // Load text fields
          textFields.forEach(field => {
            const el = document.getElementById(field);
            if (el) el.value = pluginConfig[field] || '';
          });

          // Load number fields
          numberFields.forEach(field => {
            const el = document.getElementById(field);
            if (el && pluginConfig[field] !== undefined) {
              el.value = pluginConfig[field];
            }
          });

          // Load boolean fields
          booleanFields.forEach(field => {
            const el = document.getElementById(field);
            if (el) el.checked = pluginConfig[field] || false;
          });

          // Auto-populate devices from cached discovery (from plugin startup)
          await loadCachedDevices();

          // Render device lists
          Object.keys(deviceTypes).forEach(type => renderDeviceList(type));

        } catch (err) {
          console.error('Failed to load config:', err);
          homebridge.toast.error('Failed to load configuration');
        }
      };

      // Load cached devices from plugin storage and add them to config if not already present
      const loadCachedDevices = async () => {
        try {
          const response = await homebridge.request('/get-cached-devices');
          const cachedDevices = response.devices || [];

          if (cachedDevices.length === 0) {
            return;
          }

          let addedCount = 0;

          for (const device of cachedDevices) {
            const deviceId = device.deviceId;
            const deviceName = device.deviceName || 'Unknown';
            const deviceType = device.deviceType || getDeviceTypeFromModel(device.model);

            if (!deviceId) continue;

            // Initialize array if needed
            if (!pluginConfig[deviceType]) {
              pluginConfig[deviceType] = [];
            }

            // Check if device already exists in config
            const exists = pluginConfig[deviceType].some(d => d.deviceId === deviceId);

            if (!exists) {
              // Add device with name as label
              pluginConfig[deviceType].push({
                deviceId: deviceId,
                label: deviceName
              });
              addedCount++;
            }
          }

          if (addedCount > 0) {
            console.log(`Auto-added ${addedCount} cached device(s) to configuration`);
          }
        } catch (err) {
          // Silently fail - cached devices are optional
          console.debug('No cached devices available:', err.message);
        }
      };

      // Save configuration
      const saveConfig = async () => {
        const saveBtn = document.getElementById('saveBtn');
        const saveSpinner = document.getElementById('saveSpinner');

        saveSpinner.classList.remove('d-none');
        saveBtn.disabled = true;

        try {
          // Save text fields
          textFields.forEach(field => {
            const el = document.getElementById(field);
            if (el) {
              const value = el.value.trim();
              if (value) {
                pluginConfig[field] = value;
              } else {
                delete pluginConfig[field];
              }
            }
          });

          // Save number fields
          numberFields.forEach(field => {
            const el = document.getElementById(field);
            if (el) {
              const value = parseInt(el.value, 10);
              if (!isNaN(value)) {
                pluginConfig[field] = value;
              }
            }
          });

          // Save boolean fields
          booleanFields.forEach(field => {
            const el = document.getElementById(field);
            if (el) {
              pluginConfig[field] = el.checked;
            }
          });

          // Clean up empty device arrays
          Object.keys(deviceTypes).forEach(type => {
            if (pluginConfig[type] && pluginConfig[type].length === 0) {
              delete pluginConfig[type];
            }
          });

          // Update config
          await homebridge.updatePluginConfig([pluginConfig]);
          await homebridge.savePluginConfig();

          homebridge.toast.success('Configuration saved successfully!');
        } catch (err) {
          console.error('Failed to save config:', err);
          homebridge.toast.error('Failed to save configuration: ' + err.message);
        } finally {
          saveSpinner.classList.add('d-none');
          saveBtn.disabled = false;
        }
      };

      // Load config on page load
      await loadConfig();

      // Toggle password visibility
      document.getElementById('togglePassword').addEventListener('click', () => {
        const passwordField = document.getElementById('password');
        const toggleBtn = document.getElementById('togglePassword');
        if (passwordField.type === 'password') {
          passwordField.type = 'text';
          toggleBtn.textContent = 'Hide';
        } else {
          passwordField.type = 'password';
          toggleBtn.textContent = 'Show';
        }
      });

      // Save button
      document.getElementById('saveBtn').addEventListener('click', saveConfig);

      // Test login button
      document.getElementById('testLoginBtn').addEventListener('click', async () => {
        const btn = document.getElementById('testLoginBtn');
        const spinner = document.getElementById('testLoginSpinner');
        const loginResult = document.getElementById('loginResult');

        const username = document.getElementById('username').value.trim();
        const password = document.getElementById('password').value;

        if (!username || !password) {
          homebridge.toast.warning('Please enter your credentials first.');
          loginResult.innerHTML = '<div class="alert alert-warning">Please enter your username and password in the Settings tab.</div>';
          return;
        }

        spinner.classList.remove('d-none');
        btn.disabled = true;
        loginResult.innerHTML = '';

        try {
          const response = await homebridge.request('/test-login', {
            username: username,
            password: password,
          });

          if (response.success) {
            homebridge.toast.success('Connection successful!');
            loginResult.innerHTML = `<div class="alert alert-success">${response.message}</div>`;
          } else {
            homebridge.toast.warning(response.message || 'Connection failed');
            loginResult.innerHTML = `<div class="alert alert-warning">${response.message || 'Connection failed'}</div>`;
          }
        } catch (err) {
          homebridge.toast.error(err.message || 'Connection failed');
          loginResult.innerHTML = `<div class="alert alert-danger">${err.message || 'Connection failed'}</div>`;
        } finally {
          spinner.classList.add('d-none');
          btn.disabled = false;
        }
      });

      // Discover devices button
      document.getElementById('discoverBtn').addEventListener('click', async () => {
        const btn = document.getElementById('discoverBtn');
        const spinner = document.getElementById('discoverSpinner');
        const deviceList = document.getElementById('deviceList');

        const username = document.getElementById('username').value.trim();
        const password = document.getElementById('password').value;

        if (!username || !password) {
          homebridge.toast.warning('Please enter your credentials first.');
          deviceList.innerHTML = '<div class="alert alert-warning">Please enter your username and password in the Settings tab.</div>';
          return;
        }

        spinner.classList.remove('d-none');
        btn.disabled = true;
        deviceList.innerHTML = '';

        try {
          const response = await homebridge.request('/discover', {
            username: username,
            password: password,
          });
          const devices = response.devices || [];

          if (devices.length === 0) {
            homebridge.toast.info('No devices found.');
            deviceList.innerHTML = '<div class="alert alert-info">No devices found.</div>';
          } else {
            // Auto-add discovered devices to configuration
            let addedCount = 0;
            let skippedCount = 0;
            const addedByType = {};

            for (const device of devices) {
              const deviceId = device.device || device.deviceId || '';
              const deviceName = device.deviceName || 'Unknown';
              const model = device.sku || device.model || '';

              if (!deviceId) continue;

              // Determine device type from model
              const deviceType = getDeviceTypeFromModel(model);

              // Initialize array if needed
              if (!pluginConfig[deviceType]) {
                pluginConfig[deviceType] = [];
              }

              // Check if device already exists in config
              const exists = pluginConfig[deviceType].some(d => d.deviceId === deviceId);

              if (!exists) {
                // Add device with name as label
                pluginConfig[deviceType].push({
                  deviceId: deviceId,
                  label: deviceName
                });
                addedCount++;
                addedByType[deviceType] = (addedByType[deviceType] || 0) + 1;
              } else {
                skippedCount++;
              }
            }

            // Re-render all device lists
            Object.keys(deviceTypes).forEach(type => renderDeviceList(type));

            // Build summary message
            let summaryHtml = '';
            if (addedCount > 0) {
              summaryHtml += `<div class="alert alert-success mb-2">
                <strong>Added ${addedCount} new device(s):</strong><br>`;
              for (const [type, count] of Object.entries(addedByType)) {
                const typeName = type.replace('Devices', '').replace(/([A-Z])/g, ' $1').trim();
                summaryHtml += `‚Ä¢ ${count} ${typeName} device(s)<br>`;
              }
              summaryHtml += `</div>`;
            }
            if (skippedCount > 0) {
              summaryHtml += `<div class="alert alert-info mb-2">${skippedCount} device(s) already in configuration.</div>`;
            }

            // Show device list
            let html = summaryHtml + '<ul class="list-group">';
            for (const device of devices) {
              const deviceId = device.device || device.deviceId || '';
              const model = device.sku || device.model || '';
              const deviceType = getDeviceTypeFromModel(model);
              const typeName = deviceType.replace('Devices', '');

              html += `<li class="list-group-item d-flex justify-content-between align-items-center">
                <div>
                  <strong>${device.deviceName || 'Unknown'}</strong><br>
                  <small class="text-muted">Model: ${model || 'Unknown'}</small>
                  <span class="badge bg-primary ms-2">${typeName}</span>
                </div>
                <div class="text-end">
                  <code class="user-select-all">${deviceId}</code>
                </div>
              </li>`;
            }
            html += '</ul>';
            deviceList.innerHTML = html;

            if (addedCount > 0) {
              homebridge.toast.success(`Added ${addedCount} device(s). Click "Save Configuration" to persist.`);

              // Switch to Devices tab and expand first accordion with devices
              const devicesTab = document.getElementById('devices-tab');
              if (devicesTab) {
                const tab = new bootstrap.Tab(devicesTab);
                tab.show();

                // Expand the first accordion that has devices
                setTimeout(() => {
                  for (const type of Object.keys(deviceTypes)) {
                    if (pluginConfig[type] && pluginConfig[type].length > 0) {
                      const collapseEl = document.getElementById(`${type}Collapse`);
                      if (collapseEl) {
                        const collapse = new bootstrap.Collapse(collapseEl, { toggle: true });
                        break;
                      }
                    }
                  }
                }, 100);
              }
            } else {
              homebridge.toast.info(`Found ${devices.length} device(s). All already configured.`);
            }
          }
        } catch (err) {
          homebridge.toast.error(err.message || 'Discovery failed');
          deviceList.innerHTML = `<div class="alert alert-danger">Error: ${err.message || 'Unknown error'}</div>`;
        } finally {
          spinner.classList.add('d-none');
          btn.disabled = false;
        }
      });

      // Make functions globally available
      window.addDevice = addDevice;
      window.removeDevice = removeDevice;
    })();
  </script>
</body>
</html>

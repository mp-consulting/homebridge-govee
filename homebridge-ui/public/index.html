<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Govee Plugin Settings</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
  <style>
    .card { margin-bottom: 1rem; }
    .device-list { max-height: 400px; overflow-y: auto; }
    .spinner-border { width: 1rem; height: 1rem; }
    .form-check { margin-bottom: 0.5rem; }
    .nav-tabs { margin-bottom: 1rem; }
    .info-icon {
      cursor: help;
      color: #6c757d;
      margin-left: 0.25rem;
    }
    .info-icon:hover { color: #0d6efd; }
    .device-card { border-left: 4px solid #0d6efd; }
    .device-card.ignored { border-left-color: #dc3545; opacity: 0.7; }
    .device-type-badge { font-size: 0.75rem; }
    .accordion-button:not(.collapsed) { background-color: #e7f1ff; }
    .btn-add-device { margin-bottom: 1rem; }
  </style>
</head>
<body>
  <div class="container py-4">
    <h3 class="mb-4">Govee Plugin</h3>

    <ul class="nav nav-tabs" id="mainTabs" role="tablist">
      <li class="nav-item" role="presentation">
        <button class="nav-link active" id="settings-tab" data-bs-toggle="tab" data-bs-target="#settings" type="button" role="tab">Settings</button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="connection-tab" data-bs-toggle="tab" data-bs-target="#connection" type="button" role="tab">Connection</button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="devices-tab" data-bs-toggle="tab" data-bs-target="#devices" type="button" role="tab">Devices</button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="tools-tab" data-bs-toggle="tab" data-bs-target="#tools" type="button" role="tab">Tools</button>
      </li>
    </ul>

    <div class="tab-content">
      <!-- Settings Tab -->
      <div class="tab-pane fade show active" id="settings" role="tabpanel">
        <div class="card">
          <div class="card-header">
            <h5 class="mb-0">Account Settings</h5>
          </div>
          <div class="card-body">
            <div class="mb-3">
              <label for="username" class="form-label">
                Govee Account Email
                <span class="info-icon" data-bs-toggle="tooltip" data-bs-placement="top" title="The email address you use to log in to the Govee app. Required for cloud control and device discovery.">&#9432;</span>
              </label>
              <input type="email" class="form-control" id="username" placeholder="your-email@example.com">
            </div>
            <div class="mb-3">
              <label for="password" class="form-label">
                Govee Account Password
                <span class="info-icon" data-bs-toggle="tooltip" data-bs-placement="top" title="Your Govee account password. This is stored locally and used only to authenticate with Govee servers.">&#9432;</span>
              </label>
              <div class="input-group">
                <input type="password" class="form-control" id="password">
                <button class="btn btn-outline-secondary" type="button" id="togglePassword">Show</button>
              </div>
            </div>
          </div>
        </div>

        <div class="card">
          <div class="card-header">
            <h5 class="mb-0">General Settings</h5>
          </div>
          <div class="card-body">
            <div class="form-check form-switch">
              <input class="form-check-input" type="checkbox" id="ignoreMatter">
              <label class="form-check-label" for="ignoreMatter">
                Ignore Matter Devices
                <span class="info-icon" data-bs-toggle="tooltip" data-bs-placement="top" title="Skip devices that support Matter protocol. Enable this if you're using Matter to connect those devices directly to HomeKit.">&#9432;</span>
              </label>
            </div>
            <div class="form-check form-switch">
              <input class="form-check-input" type="checkbox" id="disableDeviceLogging">
              <label class="form-check-label" for="disableDeviceLogging">
                Disable Device Logging
                <span class="info-icon" data-bs-toggle="tooltip" data-bs-placement="top" title="Stop logging device state changes to reduce log clutter. Errors will still be logged.">&#9432;</span>
              </label>
            </div>
            <div class="form-check form-switch">
              <input class="form-check-input" type="checkbox" id="colourSafeMode">
              <label class="form-check-label" for="colourSafeMode">
                Colour Safe Mode
                <span class="info-icon" data-bs-toggle="tooltip" data-bs-placement="top" title="Use a slower but more reliable method for setting colours. Enable this if you experience colour issues with your lights.">&#9432;</span>
              </label>
            </div>
          </div>
        </div>
      </div>

      <!-- Connection Tab -->
      <div class="tab-pane fade" id="connection" role="tabpanel">
        <div class="card">
          <div class="card-header">
            <h5 class="mb-0">AWS IoT Connection</h5>
          </div>
          <div class="card-body">
            <div class="form-check form-switch mb-3">
              <input class="form-check-input" type="checkbox" id="awsDisable">
              <label class="form-check-label" for="awsDisable">
                Disable AWS IoT Connection
                <span class="info-icon" data-bs-toggle="tooltip" data-bs-placement="top" title="Disable real-time cloud control via AWS IoT. The plugin will fall back to HTTP polling only. Not recommended unless you have connection issues.">&#9432;</span>
              </label>
            </div>
            <div class="mb-3">
              <label for="httpRefreshTime" class="form-label">
                HTTP Refresh Time (seconds)
                <span class="info-icon" data-bs-toggle="tooltip" data-bs-placement="top" title="How often to poll the Govee API for device state updates. Lower values mean faster updates but more API calls. Minimum 60 seconds.">&#9432;</span>
              </label>
              <input type="number" class="form-control" id="httpRefreshTime" min="60" value="60">
            </div>
          </div>
        </div>

        <div class="card">
          <div class="card-header">
            <h5 class="mb-0">LAN Connection</h5>
          </div>
          <div class="card-body">
            <div class="form-check form-switch mb-3">
              <input class="form-check-input" type="checkbox" id="lanDisable">
              <label class="form-check-label" for="lanDisable">
                Disable LAN Control
                <span class="info-icon" data-bs-toggle="tooltip" data-bs-placement="top" title="Disable local network control. LAN control is faster and works without internet. Only disable if you experience network issues.">&#9432;</span>
              </label>
            </div>
            <div class="mb-3">
              <label for="lanRefreshTime" class="form-label">
                LAN Refresh Time (seconds)
                <span class="info-icon" data-bs-toggle="tooltip" data-bs-placement="top" title="How often to poll LAN devices for state updates. Lower values mean faster updates. Minimum 15 seconds.">&#9432;</span>
              </label>
              <input type="number" class="form-control" id="lanRefreshTime" min="15" value="30">
            </div>
            <div class="mb-3">
              <label for="lanScanInterval" class="form-label">
                LAN Scan Interval (seconds)
                <span class="info-icon" data-bs-toggle="tooltip" data-bs-placement="top" title="How often to scan the network for new LAN-capable devices. Minimum 30 seconds.">&#9432;</span>
              </label>
              <input type="number" class="form-control" id="lanScanInterval" min="30" value="60">
            </div>
          </div>
        </div>

        <div class="card">
          <div class="card-header">
            <h5 class="mb-0">Bluetooth (BLE) Connection</h5>
          </div>
          <div class="card-body">
            <div class="form-check form-switch mb-3">
              <input class="form-check-input" type="checkbox" id="bleDisable">
              <label class="form-check-label" for="bleDisable">
                Disable Bluetooth Control
                <span class="info-icon" data-bs-toggle="tooltip" data-bs-placement="top" title="Disable Bluetooth Low Energy control. BLE works for nearby devices without network. Requires compatible hardware (works best on Raspberry Pi).">&#9432;</span>
              </label>
            </div>
            <div class="mb-3">
              <label for="bleRefreshTime" class="form-label">
                BLE Refresh Time (seconds)
                <span class="info-icon" data-bs-toggle="tooltip" data-bs-placement="top" title="How often to scan for BLE sensor readings (temperature, humidity, etc.). Minimum 15 seconds.">&#9432;</span>
              </label>
              <input type="number" class="form-control" id="bleRefreshTime" min="15" value="30">
            </div>
            <div class="mb-3">
              <label for="bleControlInterval" class="form-label">
                BLE Control Interval (ms)
                <span class="info-icon" data-bs-toggle="tooltip" data-bs-placement="top" title="Minimum time between BLE commands to prevent overwhelming devices. Increase if you experience connection drops. Minimum 500ms.">&#9432;</span>
              </label>
              <input type="number" class="form-control" id="bleControlInterval" min="500" value="500">
            </div>
          </div>
        </div>
      </div>

      <!-- Devices Tab -->
      <div class="tab-pane fade" id="devices" role="tabpanel">
        <div class="alert alert-info">
          <strong>Tip:</strong> Configure device-specific settings here. Use "Discover Devices" in the Tools tab to find your device IDs.
        </div>

        <div class="accordion" id="deviceAccordion">
          <!-- Light Devices -->
          <div class="accordion-item">
            <h2 class="accordion-header">
              <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#lightDevicesCollapse">
                <span class="me-2">üí°</span> Light Devices <span class="badge bg-secondary ms-2" id="lightDevicesCount">0</span>
              </button>
            </h2>
            <div id="lightDevicesCollapse" class="accordion-collapse collapse" data-bs-parent="#deviceAccordion">
              <div class="accordion-body">
                <button class="btn btn-outline-primary btn-sm btn-add-device" onclick="addDevice('lightDevices')">+ Add Light Device</button>
                <div id="lightDevicesList"></div>
              </div>
            </div>
          </div>

          <!-- Switch Devices -->
          <div class="accordion-item">
            <h2 class="accordion-header">
              <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#switchDevicesCollapse">
                <span class="me-2">üîå</span> Switch/Outlet Devices <span class="badge bg-secondary ms-2" id="switchDevicesCount">0</span>
              </button>
            </h2>
            <div id="switchDevicesCollapse" class="accordion-collapse collapse" data-bs-parent="#deviceAccordion">
              <div class="accordion-body">
                <button class="btn btn-outline-primary btn-sm btn-add-device" onclick="addDevice('switchDevices')">+ Add Switch Device</button>
                <div id="switchDevicesList"></div>
              </div>
            </div>
          </div>

          <!-- Thermo Devices -->
          <div class="accordion-item">
            <h2 class="accordion-header">
              <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#thermoDevicesCollapse">
                <span class="me-2">üå°Ô∏è</span> Temperature/Humidity Sensors <span class="badge bg-secondary ms-2" id="thermoDevicesCount">0</span>
              </button>
            </h2>
            <div id="thermoDevicesCollapse" class="accordion-collapse collapse" data-bs-parent="#deviceAccordion">
              <div class="accordion-body">
                <button class="btn btn-outline-primary btn-sm btn-add-device" onclick="addDevice('thermoDevices')">+ Add Sensor</button>
                <div id="thermoDevicesList"></div>
              </div>
            </div>
          </div>

          <!-- Leak Devices -->
          <div class="accordion-item">
            <h2 class="accordion-header">
              <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#leakDevicesCollapse">
                <span class="me-2">üíß</span> Leak Sensors <span class="badge bg-secondary ms-2" id="leakDevicesCount">0</span>
              </button>
            </h2>
            <div id="leakDevicesCollapse" class="accordion-collapse collapse" data-bs-parent="#deviceAccordion">
              <div class="accordion-body">
                <button class="btn btn-outline-primary btn-sm btn-add-device" onclick="addDevice('leakDevices')">+ Add Leak Sensor</button>
                <div id="leakDevicesList"></div>
              </div>
            </div>
          </div>

          <!-- Fan Devices -->
          <div class="accordion-item">
            <h2 class="accordion-header">
              <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#fanDevicesCollapse">
                <span class="me-2">üåÄ</span> Fan Devices <span class="badge bg-secondary ms-2" id="fanDevicesCount">0</span>
              </button>
            </h2>
            <div id="fanDevicesCollapse" class="accordion-collapse collapse" data-bs-parent="#deviceAccordion">
              <div class="accordion-body">
                <button class="btn btn-outline-primary btn-sm btn-add-device" onclick="addDevice('fanDevices')">+ Add Fan</button>
                <div id="fanDevicesList"></div>
              </div>
            </div>
          </div>

          <!-- Heater Devices -->
          <div class="accordion-item">
            <h2 class="accordion-header">
              <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#heaterDevicesCollapse">
                <span class="me-2">üî•</span> Heater Devices <span class="badge bg-secondary ms-2" id="heaterDevicesCount">0</span>
              </button>
            </h2>
            <div id="heaterDevicesCollapse" class="accordion-collapse collapse" data-bs-parent="#deviceAccordion">
              <div class="accordion-body">
                <button class="btn btn-outline-primary btn-sm btn-add-device" onclick="addDevice('heaterDevices')">+ Add Heater</button>
                <div id="heaterDevicesList"></div>
              </div>
            </div>
          </div>

          <!-- Humidifier Devices -->
          <div class="accordion-item">
            <h2 class="accordion-header">
              <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#humidifierDevicesCollapse">
                <span class="me-2">üí®</span> Humidifier Devices <span class="badge bg-secondary ms-2" id="humidifierDevicesCount">0</span>
              </button>
            </h2>
            <div id="humidifierDevicesCollapse" class="accordion-collapse collapse" data-bs-parent="#deviceAccordion">
              <div class="accordion-body">
                <button class="btn btn-outline-primary btn-sm btn-add-device" onclick="addDevice('humidifierDevices')">+ Add Humidifier</button>
                <div id="humidifierDevicesList"></div>
              </div>
            </div>
          </div>

          <!-- Purifier Devices -->
          <div class="accordion-item">
            <h2 class="accordion-header">
              <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#purifierDevicesCollapse">
                <span class="me-2">üå¨Ô∏è</span> Air Purifier Devices <span class="badge bg-secondary ms-2" id="purifierDevicesCount">0</span>
              </button>
            </h2>
            <div id="purifierDevicesCollapse" class="accordion-collapse collapse" data-bs-parent="#deviceAccordion">
              <div class="accordion-body">
                <button class="btn btn-outline-primary btn-sm btn-add-device" onclick="addDevice('purifierDevices')">+ Add Purifier</button>
                <div id="purifierDevicesList"></div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Tools Tab -->
      <div class="tab-pane fade" id="tools" role="tabpanel">
        <div class="card">
          <div class="card-header">
            <h5 class="mb-0">Account Connection Test</h5>
          </div>
          <div class="card-body">
            <p class="text-muted">Test your Govee account credentials to verify they work correctly.</p>
            <button id="testLoginBtn" class="btn btn-primary">
              <span id="testLoginSpinner" class="spinner-border d-none" role="status"></span>
              Test Connection
            </button>
            <div id="loginResult" class="mt-3"></div>
          </div>
        </div>

        <div class="card">
          <div class="card-header">
            <h5 class="mb-0">Device Discovery</h5>
          </div>
          <div class="card-body">
            <p class="text-muted">Discover all devices linked to your Govee account. Use the device IDs to configure specific devices in the Devices tab.</p>
            <button id="discoverBtn" class="btn btn-secondary">
              <span id="discoverSpinner" class="spinner-border d-none" role="status"></span>
              Discover Devices
            </button>
            <div id="deviceList" class="device-list mt-3"></div>
          </div>
        </div>

        <div class="card">
          <div class="card-header">
            <h5 class="mb-0">Documentation</h5>
          </div>
          <div class="card-body">
            <p>For more information about configuration options, see the <a href="https://github.com/mp-consulting/homebridge-govee#readme" target="_blank">README</a>.</p>
            <ul>
              <li><strong>AWS IoT:</strong> Real-time control via Govee cloud (requires credentials)</li>
              <li><strong>LAN:</strong> Local network control (faster, works without internet)</li>
              <li><strong>BLE:</strong> Bluetooth control for nearby devices (requires compatible hardware)</li>
            </ul>
          </div>
        </div>
      </div>
    </div>

    <!-- Save Button -->
    <div class="d-grid gap-2 mt-3">
      <button id="saveBtn" class="btn btn-success btn-lg">
        <span id="saveSpinner" class="spinner-border d-none" role="status"></span>
        Save Configuration
      </button>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    // Device type configurations
    const deviceTypes = {
      lightDevices: {
        fields: [
          { id: 'deviceId', label: 'Device ID', type: 'text', required: true },
          { id: 'label', label: 'Custom Label', type: 'text' },
          { id: 'ignoreDevice', label: 'Ignore Device', type: 'checkbox' },
          { id: 'showAs', label: 'Show As', type: 'select', options: [
            { value: 'default', label: 'Light (default)' },
            { value: 'switch', label: 'Switch' }
          ]},
          { id: 'customIPAddress', label: 'Custom IP Address', type: 'text', advanced: true },
          { id: 'customAddress', label: 'Custom BLE Address', type: 'text', advanced: true },
          { id: 'brightnessStep', label: 'Brightness Step', type: 'number', min: 1, max: 100, advanced: true },
          { id: 'adaptiveLightingShift', label: 'Adaptive Lighting Shift', type: 'number', advanced: true },
          { id: 'awsBrightnessNoScale', label: 'AWS Brightness No Scale', type: 'checkbox', advanced: true },
          { id: 'awsColourMode', label: 'AWS Colour Mode', type: 'select', advanced: true, options: [
            { value: 'default', label: 'Default' },
            { value: 'rgb', label: 'RGB' },
            { value: 'redgreenblue', label: 'Red/Green/Blue' }
          ]}
        ]
      },
      switchDevices: {
        fields: [
          { id: 'deviceId', label: 'Device ID', type: 'text', required: true },
          { id: 'label', label: 'Custom Label', type: 'text' },
          { id: 'ignoreDevice', label: 'Ignore Device', type: 'checkbox' },
          { id: 'showAs', label: 'Show As', type: 'select', options: [
            { value: 'default', label: 'Outlet (default)' },
            { value: 'switch', label: 'Switch' },
            { value: 'purifier', label: 'Air Purifier' },
            { value: 'heater', label: 'Heater' },
            { value: 'cooler', label: 'Cooler' },
            { value: 'tap', label: 'Tap/Faucet' },
            { value: 'valve', label: 'Valve' },
            { value: 'audio', label: 'Audio Receiver' },
            { value: 'box', label: 'Set-Top Box' },
            { value: 'stick', label: 'Streaming Stick' }
          ]},
          { id: 'temperatureSource', label: 'Temperature Source (Device ID)', type: 'text', advanced: true }
        ]
      },
      thermoDevices: {
        fields: [
          { id: 'deviceId', label: 'Device ID', type: 'text', required: true },
          { id: 'label', label: 'Custom Label', type: 'text' },
          { id: 'ignoreDevice', label: 'Ignore Device', type: 'checkbox' },
          { id: 'lowBattThreshold', label: 'Low Battery Threshold (%)', type: 'number', min: 1, max: 100 },
          { id: 'showExtraSwitch', label: 'Show Extra Switch', type: 'checkbox' }
        ]
      },
      leakDevices: {
        fields: [
          { id: 'deviceId', label: 'Device ID', type: 'text', required: true },
          { id: 'label', label: 'Custom Label', type: 'text' },
          { id: 'ignoreDevice', label: 'Ignore Device', type: 'checkbox' },
          { id: 'lowBattThreshold', label: 'Low Battery Threshold (%)', type: 'number', min: 1, max: 100 }
        ]
      },
      fanDevices: {
        fields: [
          { id: 'deviceId', label: 'Device ID', type: 'text', required: true },
          { id: 'label', label: 'Custom Label', type: 'text' },
          { id: 'ignoreDevice', label: 'Ignore Device', type: 'checkbox' },
          { id: 'hideLight', label: 'Hide Light Control', type: 'checkbox' }
        ]
      },
      heaterDevices: {
        fields: [
          { id: 'deviceId', label: 'Device ID', type: 'text', required: true },
          { id: 'label', label: 'Custom Label', type: 'text' },
          { id: 'ignoreDevice', label: 'Ignore Device', type: 'checkbox' },
          { id: 'tempReporting', label: 'Temperature Reporting', type: 'checkbox' }
        ]
      },
      humidifierDevices: {
        fields: [
          { id: 'deviceId', label: 'Device ID', type: 'text', required: true },
          { id: 'label', label: 'Custom Label', type: 'text' },
          { id: 'ignoreDevice', label: 'Ignore Device', type: 'checkbox' }
        ]
      },
      purifierDevices: {
        fields: [
          { id: 'deviceId', label: 'Device ID', type: 'text', required: true },
          { id: 'label', label: 'Custom Label', type: 'text' },
          { id: 'ignoreDevice', label: 'Ignore Device', type: 'checkbox' }
        ]
      }
    };

    let pluginConfig = { platform: 'Govee', name: 'Govee' };

    function renderDeviceField(type, index, field, value) {
      const fieldId = `${type}_${index}_${field.id}`;
      let html = '';

      if (field.type === 'checkbox') {
        html = `
          <div class="form-check form-switch mb-2">
            <input class="form-check-input device-field" type="checkbox" id="${fieldId}"
              data-type="${type}" data-index="${index}" data-field="${field.id}"
              ${value ? 'checked' : ''}>
            <label class="form-check-label" for="${fieldId}">${field.label}</label>
          </div>`;
      } else if (field.type === 'select') {
        const options = field.options.map(opt =>
          `<option value="${opt.value}" ${value === opt.value ? 'selected' : ''}>${opt.label}</option>`
        ).join('');
        html = `
          <div class="mb-2">
            <label class="form-label" for="${fieldId}">${field.label}</label>
            <select class="form-select form-select-sm device-field" id="${fieldId}"
              data-type="${type}" data-index="${index}" data-field="${field.id}">
              ${options}
            </select>
          </div>`;
      } else {
        html = `
          <div class="mb-2">
            <label class="form-label" for="${fieldId}">${field.label}${field.required ? ' *' : ''}</label>
            <input type="${field.type}" class="form-control form-control-sm device-field" id="${fieldId}"
              data-type="${type}" data-index="${index}" data-field="${field.id}"
              value="${value || ''}" ${field.min !== undefined ? `min="${field.min}"` : ''}
              ${field.max !== undefined ? `max="${field.max}"` : ''}>
          </div>`;
      }
      return html;
    }

    function renderDevice(type, index, device) {
      const config = deviceTypes[type];
      const isIgnored = device.ignoreDevice;
      const displayName = device.label || device.deviceId || 'New Device';

      const basicFields = config.fields.filter(f => !f.advanced);
      const advancedFields = config.fields.filter(f => f.advanced);

      let fieldsHtml = basicFields.map(f => renderDeviceField(type, index, f, device[f.id])).join('');

      if (advancedFields.length > 0) {
        const advancedHtml = advancedFields.map(f => renderDeviceField(type, index, f, device[f.id])).join('');
        fieldsHtml += `
          <div class="mt-2">
            <a class="btn btn-link btn-sm p-0" data-bs-toggle="collapse" href="#${type}_${index}_advanced">
              Advanced Settings
            </a>
            <div class="collapse mt-2" id="${type}_${index}_advanced">
              ${advancedHtml}
            </div>
          </div>`;
      }

      return `
        <div class="card device-card mb-2 ${isIgnored ? 'ignored' : ''}" id="${type}_${index}_card">
          <div class="card-body py-2">
            <div class="d-flex justify-content-between align-items-center mb-2">
              <strong>${displayName}</strong>
              <button class="btn btn-outline-danger btn-sm" onclick="removeDevice('${type}', ${index})">Remove</button>
            </div>
            ${fieldsHtml}
          </div>
        </div>`;
    }

    function renderDeviceList(type) {
      const devices = pluginConfig[type] || [];
      const container = document.getElementById(`${type}List`);
      const countBadge = document.getElementById(`${type}Count`);

      if (devices.length === 0) {
        container.innerHTML = '<p class="text-muted">No devices configured.</p>';
      } else {
        container.innerHTML = devices.map((device, index) => renderDevice(type, index, device)).join('');
      }

      countBadge.textContent = devices.length;

      // Add event listeners for field changes
      container.querySelectorAll('.device-field').forEach(field => {
        field.addEventListener('change', handleDeviceFieldChange);
        field.addEventListener('input', handleDeviceFieldChange);
      });
    }

    function handleDeviceFieldChange(event) {
      const field = event.target;
      const type = field.dataset.type;
      const index = parseInt(field.dataset.index);
      const fieldName = field.dataset.field;

      if (!pluginConfig[type]) pluginConfig[type] = [];
      if (!pluginConfig[type][index]) pluginConfig[type][index] = {};

      if (field.type === 'checkbox') {
        pluginConfig[type][index][fieldName] = field.checked;
      } else if (field.type === 'number') {
        const val = parseInt(field.value);
        if (!isNaN(val)) {
          pluginConfig[type][index][fieldName] = val;
        }
      } else {
        const val = field.value.trim();
        if (val) {
          pluginConfig[type][index][fieldName] = val;
        } else {
          delete pluginConfig[type][index][fieldName];
        }
      }

      // Update card appearance if ignoreDevice changed
      if (fieldName === 'ignoreDevice') {
        const card = document.getElementById(`${type}_${index}_card`);
        if (card) {
          card.classList.toggle('ignored', field.checked);
        }
      }
    }

    function addDevice(type) {
      if (!pluginConfig[type]) pluginConfig[type] = [];
      pluginConfig[type].push({ deviceId: '' });
      renderDeviceList(type);
    }

    function removeDevice(type, index) {
      if (pluginConfig[type]) {
        pluginConfig[type].splice(index, 1);
        if (pluginConfig[type].length === 0) {
          delete pluginConfig[type];
        }
        renderDeviceList(type);
      }
    }

    (async () => {
      // Get the homebridge object
      const homebridge = window.homebridge;
      if (!homebridge) {
        console.error('Homebridge UI utils not available');
        return;
      }

      // Initialize Bootstrap tooltips
      const tooltipTriggerList = document.querySelectorAll('[data-bs-toggle="tooltip"]');
      tooltipTriggerList.forEach(el => new bootstrap.Tooltip(el));

      // Field mappings
      const textFields = ['username', 'password'];
      const numberFields = ['httpRefreshTime', 'lanRefreshTime', 'lanScanInterval', 'bleRefreshTime', 'bleControlInterval'];
      const booleanFields = ['ignoreMatter', 'disableDeviceLogging', 'colourSafeMode', 'awsDisable', 'lanDisable', 'bleDisable'];

      // Load configuration
      const loadConfig = async () => {
        try {
          const config = await homebridge.getPluginConfig();
          pluginConfig = config[0] || { platform: 'Govee', name: 'Govee' };

          // Load text fields
          textFields.forEach(field => {
            const el = document.getElementById(field);
            if (el) el.value = pluginConfig[field] || '';
          });

          // Load number fields
          numberFields.forEach(field => {
            const el = document.getElementById(field);
            if (el && pluginConfig[field] !== undefined) {
              el.value = pluginConfig[field];
            }
          });

          // Load boolean fields
          booleanFields.forEach(field => {
            const el = document.getElementById(field);
            if (el) el.checked = pluginConfig[field] || false;
          });

          // Render device lists
          Object.keys(deviceTypes).forEach(type => renderDeviceList(type));

        } catch (err) {
          console.error('Failed to load config:', err);
          homebridge.toast.error('Failed to load configuration');
        }
      };

      // Save configuration
      const saveConfig = async () => {
        const saveBtn = document.getElementById('saveBtn');
        const saveSpinner = document.getElementById('saveSpinner');

        saveSpinner.classList.remove('d-none');
        saveBtn.disabled = true;

        try {
          // Save text fields
          textFields.forEach(field => {
            const el = document.getElementById(field);
            if (el) {
              const value = el.value.trim();
              if (value) {
                pluginConfig[field] = value;
              } else {
                delete pluginConfig[field];
              }
            }
          });

          // Save number fields
          numberFields.forEach(field => {
            const el = document.getElementById(field);
            if (el) {
              const value = parseInt(el.value, 10);
              if (!isNaN(value)) {
                pluginConfig[field] = value;
              }
            }
          });

          // Save boolean fields
          booleanFields.forEach(field => {
            const el = document.getElementById(field);
            if (el) {
              pluginConfig[field] = el.checked;
            }
          });

          // Clean up empty device arrays
          Object.keys(deviceTypes).forEach(type => {
            if (pluginConfig[type] && pluginConfig[type].length === 0) {
              delete pluginConfig[type];
            }
          });

          // Update config
          await homebridge.updatePluginConfig([pluginConfig]);
          await homebridge.savePluginConfig();

          homebridge.toast.success('Configuration saved successfully!');
        } catch (err) {
          console.error('Failed to save config:', err);
          homebridge.toast.error('Failed to save configuration: ' + err.message);
        } finally {
          saveSpinner.classList.add('d-none');
          saveBtn.disabled = false;
        }
      };

      // Load config on page load
      await loadConfig();

      // Toggle password visibility
      document.getElementById('togglePassword').addEventListener('click', () => {
        const passwordField = document.getElementById('password');
        const toggleBtn = document.getElementById('togglePassword');
        if (passwordField.type === 'password') {
          passwordField.type = 'text';
          toggleBtn.textContent = 'Hide';
        } else {
          passwordField.type = 'password';
          toggleBtn.textContent = 'Show';
        }
      });

      // Save button
      document.getElementById('saveBtn').addEventListener('click', saveConfig);

      // Test login button
      document.getElementById('testLoginBtn').addEventListener('click', async () => {
        const btn = document.getElementById('testLoginBtn');
        const spinner = document.getElementById('testLoginSpinner');
        const loginResult = document.getElementById('loginResult');

        const username = document.getElementById('username').value.trim();
        const password = document.getElementById('password').value;

        if (!username || !password) {
          homebridge.toast.warning('Please enter your credentials first.');
          loginResult.innerHTML = '<div class="alert alert-warning">Please enter your username and password in the Settings tab.</div>';
          return;
        }

        spinner.classList.remove('d-none');
        btn.disabled = true;
        loginResult.innerHTML = '';

        try {
          const response = await homebridge.request('/test-login', {
            username: username,
            password: password,
          });

          if (response.success) {
            homebridge.toast.success('Connection successful!');
            loginResult.innerHTML = `<div class="alert alert-success">${response.message}</div>`;
          } else {
            homebridge.toast.warning(response.message || 'Connection failed');
            loginResult.innerHTML = `<div class="alert alert-warning">${response.message || 'Connection failed'}</div>`;
          }
        } catch (err) {
          homebridge.toast.error(err.message || 'Connection failed');
          loginResult.innerHTML = `<div class="alert alert-danger">${err.message || 'Connection failed'}</div>`;
        } finally {
          spinner.classList.add('d-none');
          btn.disabled = false;
        }
      });

      // Discover devices button
      document.getElementById('discoverBtn').addEventListener('click', async () => {
        const btn = document.getElementById('discoverBtn');
        const spinner = document.getElementById('discoverSpinner');
        const deviceList = document.getElementById('deviceList');

        const username = document.getElementById('username').value.trim();
        const password = document.getElementById('password').value;

        if (!username || !password) {
          homebridge.toast.warning('Please enter your credentials first.');
          deviceList.innerHTML = '<div class="alert alert-warning">Please enter your username and password in the Settings tab.</div>';
          return;
        }

        spinner.classList.remove('d-none');
        btn.disabled = true;
        deviceList.innerHTML = '';

        try {
          const response = await homebridge.request('/discover', {
            username: username,
            password: password,
          });
          const devices = response.devices || [];

          if (devices.length === 0) {
            homebridge.toast.info('No devices found.');
            deviceList.innerHTML = '<div class="alert alert-info">No devices found.</div>';
          } else {
            homebridge.toast.success(`Found ${devices.length} device(s).`);
            let html = '<ul class="list-group">';
            for (const device of devices) {
              html += `<li class="list-group-item d-flex justify-content-between align-items-center">
                <div>
                  <strong>${device.deviceName || 'Unknown'}</strong><br>
                  <small class="text-muted">Model: ${device.model || 'Unknown'}</small>
                </div>
                <div class="text-end">
                  <code class="user-select-all">${device.deviceId || ''}</code>
                  <br><small class="text-muted">Copy this ID</small>
                </div>
              </li>`;
            }
            html += '</ul>';
            deviceList.innerHTML = html;
          }
        } catch (err) {
          homebridge.toast.error(err.message || 'Discovery failed');
          deviceList.innerHTML = `<div class="alert alert-danger">Error: ${err.message || 'Unknown error'}</div>`;
        } finally {
          spinner.classList.add('d-none');
          btn.disabled = false;
        }
      });

      // Make functions globally available
      window.addDevice = addDevice;
      window.removeDevice = removeDevice;
    })();
  </script>
</body>
</html>

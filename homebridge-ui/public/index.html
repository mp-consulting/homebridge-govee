<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Govee Plugin Settings</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
  <style>
    .card { margin-bottom: 1rem; }
    .device-list { max-height: 300px; overflow-y: auto; }
    .spinner-border { width: 1rem; height: 1rem; }
  </style>
</head>
<body>
  <div class="container py-4">
    <h3 class="mb-4">Govee Plugin</h3>

    <div class="card">
      <div class="card-header">
        <h5 class="mb-0">Account Connection Test</h5>
      </div>
      <div class="card-body">
        <p class="text-muted">Test your Govee account credentials before saving the configuration.</p>
        <div class="mb-3">
          <label for="usernameDisplay" class="form-label">Username (from config)</label>
          <input type="text" class="form-control" id="usernameDisplay" readonly>
        </div>
        <div class="mb-3">
          <label for="passwordDisplay" class="form-label">Password (from config)</label>
          <div class="input-group">
            <input type="password" class="form-control" id="passwordDisplay" readonly>
            <button class="btn btn-outline-secondary" type="button" id="togglePassword">Show</button>
          </div>
        </div>
        <button id="testLoginBtn" class="btn btn-primary">
          <span id="testLoginSpinner" class="spinner-border d-none" role="status"></span>
          Test Connection
        </button>
        <div id="loginResult" class="mt-3"></div>
      </div>
    </div>

    <div class="card">
      <div class="card-header">
        <h5 class="mb-0">Device Discovery</h5>
      </div>
      <div class="card-body">
        <p class="text-muted">Discover devices linked to your Govee account.</p>
        <button id="discoverBtn" class="btn btn-secondary">
          <span id="discoverSpinner" class="spinner-border d-none" role="status"></span>
          Discover Devices
        </button>
        <div id="deviceList" class="device-list mt-3"></div>
      </div>
    </div>

    <div class="card">
      <div class="card-header">
        <h5 class="mb-0">Documentation</h5>
      </div>
      <div class="card-body">
        <p>For more information about configuration options, see the <a href="https://github.com/mp-consulting/homebridge-govee#readme" target="_blank">README</a>.</p>
        <ul>
          <li><strong>AWS IoT:</strong> Real-time control via Govee cloud</li>
          <li><strong>LAN:</strong> Local network control (faster, no internet required)</li>
          <li><strong>BLE:</strong> Bluetooth control for nearby devices</li>
        </ul>
      </div>
    </div>
  </div>

  <script>
    (async () => {
      // Get the homebridge object
      const homebridge = window.homebridge;
      if (!homebridge) {
        console.error('Homebridge UI utils not available');
        return;
      }

      // Load and display credentials from config
      const loadCredentials = async () => {
        try {
          const config = await homebridge.getPluginConfig();
          const pluginConfig = config[0] || {};
          document.getElementById('usernameDisplay').value = pluginConfig.username || '(not configured)';
          document.getElementById('passwordDisplay').value = pluginConfig.password || '';
          if (!pluginConfig.username || !pluginConfig.password) {
            document.getElementById('loginResult').innerHTML =
              '<div class="alert alert-warning">Please configure your username and password in the Settings tab first.</div>';
          }
        } catch (err) {
          console.error('Failed to load config:', err);
        }
      };

      // Load credentials on page load
      await loadCredentials();

      // Toggle password visibility
      document.getElementById('togglePassword').addEventListener('click', () => {
        const passwordField = document.getElementById('passwordDisplay');
        const toggleBtn = document.getElementById('togglePassword');
        if (passwordField.type === 'password') {
          passwordField.type = 'text';
          toggleBtn.textContent = 'Hide';
        } else {
          passwordField.type = 'password';
          toggleBtn.textContent = 'Show';
        }
      });

      // Test login button
      document.getElementById('testLoginBtn').addEventListener('click', async () => {
        const btn = document.getElementById('testLoginBtn');
        const spinner = document.getElementById('testLoginSpinner');
        const loginResult = document.getElementById('loginResult');

        spinner.classList.remove('d-none');
        btn.disabled = true;
        loginResult.innerHTML = '';

        try {
          const config = await homebridge.getPluginConfig();
          const pluginConfig = config[0] || {};

          if (!pluginConfig.username || !pluginConfig.password) {
            homebridge.toast.warning('Please enter your credentials in the config first.');
            loginResult.innerHTML = '<div class="alert alert-warning">Please configure your username and password in the Settings tab first.</div>';
            return;
          }

          const response = await homebridge.request('/test-login', {
            username: pluginConfig.username,
            password: pluginConfig.password,
          });

          if (response.success) {
            homebridge.toast.success('Connection successful!');
            loginResult.innerHTML = `<div class="alert alert-success">${response.message}</div>`;
          } else {
            homebridge.toast.warning(response.message || 'Connection failed');
            loginResult.innerHTML = `<div class="alert alert-warning">${response.message || 'Connection failed'}</div>`;
          }
        } catch (err) {
          homebridge.toast.error(err.message || 'Connection failed');
          loginResult.innerHTML = `<div class="alert alert-danger">${err.message || 'Connection failed'}</div>`;
        } finally {
          spinner.classList.add('d-none');
          btn.disabled = false;
        }
      });

      // Discover devices button
      document.getElementById('discoverBtn').addEventListener('click', async () => {
        const btn = document.getElementById('discoverBtn');
        const spinner = document.getElementById('discoverSpinner');
        const deviceList = document.getElementById('deviceList');

        spinner.classList.remove('d-none');
        btn.disabled = true;
        deviceList.innerHTML = '';

        try {
          const config = await homebridge.getPluginConfig();
          const pluginConfig = config[0] || {};

          if (!pluginConfig.username || !pluginConfig.password) {
            homebridge.toast.warning('Please enter your credentials in the config first.');
            return;
          }

          const response = await homebridge.request('/discover', {
            username: pluginConfig.username,
            password: pluginConfig.password,
          });
          const devices = response.devices || [];

          if (devices.length === 0) {
            homebridge.toast.info('No devices found.');
            deviceList.innerHTML = '<div class="alert alert-info">No devices found. Please ensure your credentials are correct.</div>';
          } else {
            homebridge.toast.success(`Found ${devices.length} device(s).`);
            let html = '<ul class="list-group">';
            for (const device of devices) {
              html += `<li class="list-group-item d-flex justify-content-between align-items-center">
                <span><strong>${device.deviceName || 'Unknown'}</strong> (${device.model || 'Unknown'})</span>
                <span class="badge bg-secondary">${device.deviceId || ''}</span>
              </li>`;
            }
            html += '</ul>';
            deviceList.innerHTML = html;
          }
        } catch (err) {
          homebridge.toast.error(err.message || 'Discovery failed');
          deviceList.innerHTML = `<div class="alert alert-danger">Error: ${err.message || 'Unknown error'}</div>`;
        } finally {
          spinner.classList.add('d-none');
          btn.disabled = false;
        }
      });
    })();
  </script>
</body>
</html>

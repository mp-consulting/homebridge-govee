<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Govee Plugin Settings</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
  <style>
    .card { margin-bottom: 1rem; }
    .device-list { max-height: 300px; overflow-y: auto; }
    .spinner-border { width: 1rem; height: 1rem; }
    .form-check { margin-bottom: 0.5rem; }
    .nav-tabs { margin-bottom: 1rem; }
  </style>
</head>
<body>
  <div class="container py-4">
    <h3 class="mb-4">Govee Plugin</h3>

    <ul class="nav nav-tabs" id="mainTabs" role="tablist">
      <li class="nav-item" role="presentation">
        <button class="nav-link active" id="settings-tab" data-bs-toggle="tab" data-bs-target="#settings" type="button" role="tab">Settings</button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="connection-tab" data-bs-toggle="tab" data-bs-target="#connection" type="button" role="tab">Connection</button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="tools-tab" data-bs-toggle="tab" data-bs-target="#tools" type="button" role="tab">Tools</button>
      </li>
    </ul>

    <div class="tab-content">
      <!-- Settings Tab -->
      <div class="tab-pane fade show active" id="settings" role="tabpanel">
        <div class="card">
          <div class="card-header">
            <h5 class="mb-0">Account Settings</h5>
          </div>
          <div class="card-body">
            <div class="mb-3">
              <label for="username" class="form-label">Govee Account Email</label>
              <input type="email" class="form-control" id="username" placeholder="your-email@example.com">
              <div class="form-text">Your Govee account email address.</div>
            </div>
            <div class="mb-3">
              <label for="password" class="form-label">Govee Account Password</label>
              <div class="input-group">
                <input type="password" class="form-control" id="password">
                <button class="btn btn-outline-secondary" type="button" id="togglePassword">Show</button>
              </div>
              <div class="form-text">Your Govee account password.</div>
            </div>
          </div>
        </div>

        <div class="card">
          <div class="card-header">
            <h5 class="mb-0">General Settings</h5>
          </div>
          <div class="card-body">
            <div class="form-check form-switch">
              <input class="form-check-input" type="checkbox" id="ignoreMatter">
              <label class="form-check-label" for="ignoreMatter">Ignore Matter Devices</label>
            </div>
            <div class="form-check form-switch">
              <input class="form-check-input" type="checkbox" id="disableDeviceLogging">
              <label class="form-check-label" for="disableDeviceLogging">Disable Device Logging</label>
            </div>
            <div class="form-check form-switch">
              <input class="form-check-input" type="checkbox" id="colourSafeMode">
              <label class="form-check-label" for="colourSafeMode">Colour Safe Mode</label>
            </div>
          </div>
        </div>
      </div>

      <!-- Connection Tab -->
      <div class="tab-pane fade" id="connection" role="tabpanel">
        <div class="card">
          <div class="card-header">
            <h5 class="mb-0">AWS IoT Connection</h5>
          </div>
          <div class="card-body">
            <div class="form-check form-switch mb-3">
              <input class="form-check-input" type="checkbox" id="awsDisable">
              <label class="form-check-label" for="awsDisable">Disable AWS IoT Connection</label>
            </div>
            <div class="mb-3">
              <label for="httpRefreshTime" class="form-label">HTTP Refresh Time (seconds)</label>
              <input type="number" class="form-control" id="httpRefreshTime" min="60" value="60">
              <div class="form-text">How often to poll the Govee API for device updates (minimum 60).</div>
            </div>
          </div>
        </div>

        <div class="card">
          <div class="card-header">
            <h5 class="mb-0">LAN Connection</h5>
          </div>
          <div class="card-body">
            <div class="form-check form-switch mb-3">
              <input class="form-check-input" type="checkbox" id="lanDisable">
              <label class="form-check-label" for="lanDisable">Disable LAN Control</label>
            </div>
            <div class="mb-3">
              <label for="lanRefreshTime" class="form-label">LAN Refresh Time (seconds)</label>
              <input type="number" class="form-control" id="lanRefreshTime" min="15" value="30">
            </div>
            <div class="mb-3">
              <label for="lanScanInterval" class="form-label">LAN Scan Interval (seconds)</label>
              <input type="number" class="form-control" id="lanScanInterval" min="30" value="60">
            </div>
          </div>
        </div>

        <div class="card">
          <div class="card-header">
            <h5 class="mb-0">Bluetooth (BLE) Connection</h5>
          </div>
          <div class="card-body">
            <div class="form-check form-switch mb-3">
              <input class="form-check-input" type="checkbox" id="bleDisable">
              <label class="form-check-label" for="bleDisable">Disable Bluetooth Control</label>
            </div>
            <div class="mb-3">
              <label for="bleRefreshTime" class="form-label">BLE Refresh Time (seconds)</label>
              <input type="number" class="form-control" id="bleRefreshTime" min="15" value="30">
            </div>
            <div class="mb-3">
              <label for="bleControlInterval" class="form-label">BLE Control Interval (ms)</label>
              <input type="number" class="form-control" id="bleControlInterval" min="500" value="500">
            </div>
          </div>
        </div>
      </div>

      <!-- Tools Tab -->
      <div class="tab-pane fade" id="tools" role="tabpanel">
        <div class="card">
          <div class="card-header">
            <h5 class="mb-0">Account Connection Test</h5>
          </div>
          <div class="card-body">
            <p class="text-muted">Test your Govee account credentials.</p>
            <button id="testLoginBtn" class="btn btn-primary">
              <span id="testLoginSpinner" class="spinner-border d-none" role="status"></span>
              Test Connection
            </button>
            <div id="loginResult" class="mt-3"></div>
          </div>
        </div>

        <div class="card">
          <div class="card-header">
            <h5 class="mb-0">Device Discovery</h5>
          </div>
          <div class="card-body">
            <p class="text-muted">Discover devices linked to your Govee account.</p>
            <button id="discoverBtn" class="btn btn-secondary">
              <span id="discoverSpinner" class="spinner-border d-none" role="status"></span>
              Discover Devices
            </button>
            <div id="deviceList" class="device-list mt-3"></div>
          </div>
        </div>

        <div class="card">
          <div class="card-header">
            <h5 class="mb-0">Documentation</h5>
          </div>
          <div class="card-body">
            <p>For more information about configuration options, see the <a href="https://github.com/mp-consulting/homebridge-govee#readme" target="_blank">README</a>.</p>
            <ul>
              <li><strong>AWS IoT:</strong> Real-time control via Govee cloud</li>
              <li><strong>LAN:</strong> Local network control (faster, no internet required)</li>
              <li><strong>BLE:</strong> Bluetooth control for nearby devices</li>
            </ul>
          </div>
        </div>
      </div>
    </div>

    <!-- Save Button -->
    <div class="d-grid gap-2 mt-3">
      <button id="saveBtn" class="btn btn-success btn-lg">
        <span id="saveSpinner" class="spinner-border d-none" role="status"></span>
        Save Configuration
      </button>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    (async () => {
      // Get the homebridge object
      const homebridge = window.homebridge;
      if (!homebridge) {
        console.error('Homebridge UI utils not available');
        return;
      }

      // Field mappings
      const textFields = ['username', 'password'];
      const numberFields = ['httpRefreshTime', 'lanRefreshTime', 'lanScanInterval', 'bleRefreshTime', 'bleControlInterval'];
      const booleanFields = ['ignoreMatter', 'disableDeviceLogging', 'colourSafeMode', 'awsDisable', 'lanDisable', 'bleDisable'];

      // Load configuration
      const loadConfig = async () => {
        try {
          const config = await homebridge.getPluginConfig();
          const pluginConfig = config[0] || {};

          // Load text fields
          textFields.forEach(field => {
            const el = document.getElementById(field);
            if (el) el.value = pluginConfig[field] || '';
          });

          // Load number fields
          numberFields.forEach(field => {
            const el = document.getElementById(field);
            if (el && pluginConfig[field] !== undefined) {
              el.value = pluginConfig[field];
            }
          });

          // Load boolean fields
          booleanFields.forEach(field => {
            const el = document.getElementById(field);
            if (el) el.checked = pluginConfig[field] || false;
          });

        } catch (err) {
          console.error('Failed to load config:', err);
          homebridge.toast.error('Failed to load configuration');
        }
      };

      // Save configuration
      const saveConfig = async () => {
        const saveBtn = document.getElementById('saveBtn');
        const saveSpinner = document.getElementById('saveSpinner');

        saveSpinner.classList.remove('d-none');
        saveBtn.disabled = true;

        try {
          const config = await homebridge.getPluginConfig();
          const pluginConfig = config[0] || { platform: 'Govee', name: 'Govee' };

          // Save text fields
          textFields.forEach(field => {
            const el = document.getElementById(field);
            if (el) {
              const value = el.value.trim();
              if (value) {
                pluginConfig[field] = value;
              } else {
                delete pluginConfig[field];
              }
            }
          });

          // Save number fields
          numberFields.forEach(field => {
            const el = document.getElementById(field);
            if (el) {
              const value = parseInt(el.value, 10);
              if (!isNaN(value)) {
                pluginConfig[field] = value;
              }
            }
          });

          // Save boolean fields
          booleanFields.forEach(field => {
            const el = document.getElementById(field);
            if (el) {
              pluginConfig[field] = el.checked;
            }
          });

          // Update config
          await homebridge.updatePluginConfig([pluginConfig]);
          await homebridge.savePluginConfig();

          homebridge.toast.success('Configuration saved successfully!');
        } catch (err) {
          console.error('Failed to save config:', err);
          homebridge.toast.error('Failed to save configuration: ' + err.message);
        } finally {
          saveSpinner.classList.add('d-none');
          saveBtn.disabled = false;
        }
      };

      // Load config on page load
      await loadConfig();

      // Toggle password visibility
      document.getElementById('togglePassword').addEventListener('click', () => {
        const passwordField = document.getElementById('password');
        const toggleBtn = document.getElementById('togglePassword');
        if (passwordField.type === 'password') {
          passwordField.type = 'text';
          toggleBtn.textContent = 'Hide';
        } else {
          passwordField.type = 'password';
          toggleBtn.textContent = 'Show';
        }
      });

      // Save button
      document.getElementById('saveBtn').addEventListener('click', saveConfig);

      // Test login button
      document.getElementById('testLoginBtn').addEventListener('click', async () => {
        const btn = document.getElementById('testLoginBtn');
        const spinner = document.getElementById('testLoginSpinner');
        const loginResult = document.getElementById('loginResult');

        const username = document.getElementById('username').value.trim();
        const password = document.getElementById('password').value;

        if (!username || !password) {
          homebridge.toast.warning('Please enter your credentials first.');
          loginResult.innerHTML = '<div class="alert alert-warning">Please enter your username and password in the Settings tab.</div>';
          return;
        }

        spinner.classList.remove('d-none');
        btn.disabled = true;
        loginResult.innerHTML = '';

        try {
          const response = await homebridge.request('/test-login', {
            username: username,
            password: password,
          });

          if (response.success) {
            homebridge.toast.success('Connection successful!');
            loginResult.innerHTML = `<div class="alert alert-success">${response.message}</div>`;
          } else {
            homebridge.toast.warning(response.message || 'Connection failed');
            loginResult.innerHTML = `<div class="alert alert-warning">${response.message || 'Connection failed'}</div>`;
          }
        } catch (err) {
          homebridge.toast.error(err.message || 'Connection failed');
          loginResult.innerHTML = `<div class="alert alert-danger">${err.message || 'Connection failed'}</div>`;
        } finally {
          spinner.classList.add('d-none');
          btn.disabled = false;
        }
      });

      // Discover devices button
      document.getElementById('discoverBtn').addEventListener('click', async () => {
        const btn = document.getElementById('discoverBtn');
        const spinner = document.getElementById('discoverSpinner');
        const deviceList = document.getElementById('deviceList');

        const username = document.getElementById('username').value.trim();
        const password = document.getElementById('password').value;

        if (!username || !password) {
          homebridge.toast.warning('Please enter your credentials first.');
          deviceList.innerHTML = '<div class="alert alert-warning">Please enter your username and password in the Settings tab.</div>';
          return;
        }

        spinner.classList.remove('d-none');
        btn.disabled = true;
        deviceList.innerHTML = '';

        try {
          const response = await homebridge.request('/discover', {
            username: username,
            password: password,
          });
          const devices = response.devices || [];

          if (devices.length === 0) {
            homebridge.toast.info('No devices found.');
            deviceList.innerHTML = '<div class="alert alert-info">No devices found.</div>';
          } else {
            homebridge.toast.success(`Found ${devices.length} device(s).`);
            let html = '<ul class="list-group">';
            for (const device of devices) {
              html += `<li class="list-group-item d-flex justify-content-between align-items-center">
                <span><strong>${device.deviceName || 'Unknown'}</strong> (${device.model || 'Unknown'})</span>
                <span class="badge bg-secondary">${device.deviceId || ''}</span>
              </li>`;
            }
            html += '</ul>';
            deviceList.innerHTML = html;
          }
        } catch (err) {
          homebridge.toast.error(err.message || 'Discovery failed');
          deviceList.innerHTML = `<div class="alert alert-danger">Error: ${err.message || 'Unknown error'}</div>`;
        } finally {
          spinner.classList.add('d-none');
          btn.disabled = false;
        }
      });
    })();
  </script>
</body>
</html>
